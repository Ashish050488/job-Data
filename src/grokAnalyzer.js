import Groq from "groq-sdk";
import { GROQ_API_KEY } from './env.js';
import { sleep,StripHtml } from './utils.js';

const groq = new Groq({ apiKey: GROQ_API_KEY });

const MODEL_NAME = "llama-3.1-8b-instant"; 
const MAX_RETRIES = 5;

/**
 * IMPROVED VERSION - Analyzes job description using Groq for German language requirements
 * 
 * KEY IMPROVEMENTS:
 * - Recognizes "Fluency in German" as requirement (not just "nice to have")
 * - Catches "German native speaker" patterns
 * - Detects "professional fluency in German"
 * - Finds "(required)" in parentheses
 * - Detects "(mandatory)" in parentheses
 */
export async function analyzeJobWithGroq(jobTitle, description) {
    if (!description || description.length < 50) return null;

    const cleanDescription= StripHtml(description)
    let descriptionSnippet;
if (cleanDescription.length > 4000) {
    const first = cleanDescription.substring(0, 1500);
    const last = cleanDescription.slice(-2500);
    descriptionSnippet = first + "\n...\n" + last;
} else {
    descriptionSnippet = cleanDescription;
}

const prompt = `
Does this job REQUIRE German language skills? Look ONLY at the DESCRIPTION text below.
If ANY pattern from the REQUIRED list appears in the description, you MUST return german_required: true. Do not overthink or second-guess a match.

REQUIRED (return true):
- "Fluent in German" or "Fluency in German" in requirements
- "German native speaker" or "Native German"
- "German (mandatory)" or "German (required)"
- "German required" or "must speak German"
- "Professional fluency in German" or "Business-level German"
- "German B1/B2/C1/C2" level mentioned
- "Bilingual" with German and English
- "Fließend Deutsch" or "Deutschkenntnisse erforderlich"
- "Native-level proficiency" or "near-native proficiency" in German
- "Native or professional proficiency" in German context
- "deutschsprachig" or "German-speaking" as requirement
- "proficiency in German" in requirements section
- Description is written entirely in German language

NOT REQUIRED (return false):
- "German is a plus" or "nice to have" or "von Vorteil"
- "wünschenswert" or "beneficial" or "runden dein Profil ab"
- German not mentioned at all
- Job is LOCATED in Germany but does not require German language skills
- "must reside in Germany" is about location, NOT language

DESCRIPTION: "${descriptionSnippet}"

Now classify the domain using this job title: "${jobTitle}"
- "Technical": Software, Data, AI, DevOps, Engineering, IT
- "Non-Technical": Product, Marketing, Sales, HR, Finance
- "Unclear": If ambiguous

Return ONLY this JSON:
{
  "german_required": true or false,
  "domain": "Technical" or "Non-Technical",
  "sub_domain": "specific area like Sales, Backend, Marketing",
  "confidence": 0.0 to 1.0,
  "evidence": {
    "german_reason": "quote the exact text that proves your answer"
  }
}
`;

    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
        try {
            const chatCompletion = await groq.chat.completions.create({
                messages: [
                    { role: "system", content: "You are a JSON-only API. Return pure JSON." },
                    { role: "user", content: prompt }
                ],
                model: MODEL_NAME,
                temperature: 0, 
                response_format: { type: "json_object" } 
            });

            const content = chatCompletion.choices[0]?.message?.content;
            if (!content) throw new Error("Empty response from Groq");

            const data = JSON.parse(content);
            
            const normalizedData = {
                german_required: data.german_required === true || data.german_required === "true",
                domain: data.domain,
                sub_domain: data.sub_domain,
                confidence: Number(data.confidence) || 0,
                evidence: data.evidence || {
                    german_reason: "No reason provided"
                }
            };
            
            console.log(`[AI] ${jobTitle.substring(0, 20)}... | Ger: ${normalizedData.german_required}`);
            return normalizedData;

        } catch (err) {
            if (err.status === 429 || err.message.includes('429')) {
                let waitTime = 60000;

                if (err.headers && err.headers['retry-after']) {
                    const retryHeader = parseInt(err.headers['retry-after'], 10);
                    if (!isNaN(retryHeader)) {
                        waitTime = (retryHeader * 1000) + 1000;
                    }
                } else {
                    const match = err.message.match(/try again in ([\d.]+)s/);
                    if (match && match[1]) {
                        waitTime = Math.ceil(parseFloat(match[1]) * 1000) + 1000;
                    }
                }

                console.warn(`[AI] Groq Rate Limit. Waiting ${waitTime/1000}s...`);
                await sleep(waitTime);
            } else {
                console.warn(`[AI] Error: ${err.message}`);
                if (attempt === MAX_RETRIES) return null;
                await sleep(2000);
            }
        }
    }
    return null;
}

export async function isGermanRequired(description, jobTitle) {
    const result = await analyzeJobWithGroq(jobTitle, description);
    return result ? result.german_required : true; 
}